<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/av-icons.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-progress/paper-progress.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/styles/shared-styles.html">
<link rel="import" href="/elements/loading-box.html">
<link rel="import" href="/behaviors/api-requestor.html">

<dom-module id="upload-video">
	<template>
		<style>
			:host {
				display: block;
			}
			paper-card {
				width: 100%;
				max-width: 800px;
				height: 100%;
				max-height: 250px;
				padding: 15px;
				@apply(--layout-vertical);
			}
			#drop_area {
				@apply(--layout-flex);
				border: 1px dashed #333;

				@apply(--layout-horizontal);
				@apply(--layout-center-center);
			}
			#action_buttons {
				@apply(--layout-horizontal);
				@apply(--layout-center);
				margin-top: 10px;
				color: var(--primary-color);
			}
			#progress {
				@apply(--layout-flex);
			}
			paper-button {
				--paper-button-ink-color: var(--accent-color);
			}
			paper-icon-button {
				color: #333;
				--paper-icon-button-ink-color: var(--accent-color);
			}
		</style>
		<paper-card>
			<div id="drop_area">
				<div hidden="[[uploading]]">
					<iron-icon icon="file-upload"></iron-icon>
					<span>Drag & Drop a Video File</span>
				</div>
				<loading-box active="[[uploading]]"></loading-box>
			</div>
			<div id="action_buttons">
				<paper-progress id="progress"></paper-progress>
				<paper-icon-button hidden="[[!uploading]]" icon="av:pause"></paper-icon-button>
				<paper-button id="browse_button">
					<iron-icon icon="folder-open"></iron-icon>
					<span>BROWSE</span>
				</paper-button>
			</div>
		</paper-card>
	</template>
	<script>
		Polymer({
			is: 'upload-video',
			behaviors: [Behaviors.api_requestor],
			properties: {
				uploading: {
					type: Boolean,
					value: false
				}
			},
			ready: function () {
				this.flow = new Flow({
					target: '/api/video-chunks'
				});

				this.flow.assignBrowse(this.$.browse_button);
				this.flow.assignDrop(this.$.drop_area);

				var self = this;

				/* A file is about to be added to the upload queue, we can return false to stop it. */
				this.flow.on('fileAdded', function (file, event) {
			    if (self.uploading) { return false; }
			    self.uploading = true;
				});
				
				/* 1+ files were just added to the upload queue */
				this.flow.on('filesSubmitted', function (file_array, event) {
			  
			  	/* Before we start uploading, we need to get a UUID. The server will 
			  	 * check to see if this upload was started earlier and either give us 
			  	 * the existing one or reserve a new one for us. */
			  	var file_id = file_array[0].uniqueIdentifier;
			  	self.make_api_request({
						verb: 'GET',
			  		resource: ['upload-tokens', file_id],
			  		callback: function (result) {
			  			console.log(result.body);
			  			if (result.body.data.video_id) {
			  				self.uploading = true;
			  				self.flow.opts.query.video_id = result.body.data.video_id;
			  				self.flow.upload();
			  			}
			  		}
			  	});
				});
				

				/* One all of the chunks have finished uploading, we can send a request to finalize the upload (merge the chunks) */
				this.flow.on('complete', function () {
					var total_chunks = self.flow.files[0].chunks.length;
					self.make_api_request({
						verb: 'POST',
			  		resource: 'videos',
			  		query: {video_id: self.flow.opts.query.video_id, flowTotalChunks: total_chunks},
			  		callback: function (result) {
			  			console.log(result.body);
			  		}
			  	});			
				});


				this.flow.on('fileError', function(file, message){
				  console.log(file, message);
				});
			}
		});
	</script>
</dom-module>